/**
 * File:	include/profile-manager/complex.ycp
 * Package:	Configuration of profile-manager
 * Summary:	Dialogs definitions
 * Authors:	Jiri Suchomel <jsuchome@suse.cz>
 *
 * $Id$
 */

{

textdomain "profile-manager";

import "Wizard";
import "Wizard_hw";

import "ProfileManager";

include "ui/common_popups.ycp";
include "ui/common_messages.ycp";

include "profile-manager/helps.ycp";
include "profile-manager/routines.ycp";


/**
 * Read settings dialog
 * @return `abort if aborted and `next otherwise
 */
global define symbol ReadDialog() ``{
    Wizard::RestoreHelp(HELPS["read"]:"");
    ProfileManager::AbortFunction = ``{ return PollAbort();};
    boolean ret = ProfileManager::Read();
    return ret ? `next : `abort;
}

/**
 * Write settings dialog
 * @return `abort if aborted and `next otherwise
 */
global define symbol WriteDialog() ``{
    Wizard::RestoreHelp(HELPS["write"]:"");
    boolean ret = ProfileManager::Write();
    return ret ? `next : `abort;
}

/**
 * Main dialog
 * @return any Returned value from UserInput() call
 */
global define any MainDialog () ``{
	// Caption of the dialog:
    string caption = _("System configuration profile management");

	map profiles = ProfileManager::profiles;
    string active = ProfileManager::active_profile;
    boolean enabled = ProfileManager::enabled;

	string state_label = (enabled)? _("SCPM is enabled with Resource Set \"")+ProfileManager::current_resources+"\"." : _("SCPM is disabled.");
    string selected = "";

    term contents = `HBox(
	`HSpacing(1.5),
	`VBox(
        `VSpacing(1),
		// frame label:
        `Frame(_("Profile management"), `HBox(`HSpacing(1),
            `VBox(
                `VSpacing(0.2),
		        `Table(`id(`profiles),
                    `header(_("active"),
                            _("Name"),
                            _("Description")),
                    ProfileManager::GetProfilesAsItems()
                    ),
                `VSpacing(0.2),
		        `HBox(
                    `Left(
                        `PushButton(`id(`switch_button), _("&Switch to..."))),
		            `PushButton(`id(`add_button), _("&Add")),
		            `PushButton(`id(`edit_button), _("&Edit")),
		            `PushButton(`id(`delete_button), _("&Delete"))
				    ),
                `VSpacing(0.2)
                ),
            `HSpacing(1)
                )),
        `VSpacing(1),
		// frame label:
		`Frame(_("General Setup"), `VBox(`VSpacing(0.2),
            `HBox(
                `HSpacing(1),
			    `Label (state_label),
		        `Right(`PushButton(`id(`options_button), _("O&ptions"))),
                `HSpacing(1)
                ),
            `VSpacing(0.2))),
        `VSpacing(1)
		),
	`HSpacing(1.5));


/*    Wizard::SetContents ( caption,
				contents,
                HELPS["main"]:"",
                false,true);*/

    Wizard::SetContentsButtons ( caption,
				contents,
                HELPS["main"]:"",
                BackButtonLabel (),
				CloseButtonLabel () );

    Wizard::ReplaceBackButton (`HBox());
    Wizard::ReplaceAbortButton (`HBox());

    if (ProfileManager::first_time && !enabled)
        IntroductionPopup();


    if (enabled) {
        UI::ChangeWidget(`id(`profiles), `CurrentItem, ProfileManager::active_profile);
        UI::SetFocus(`id(`profiles));
    }

    UI::ChangeWidget(`id(`profiles), `Enabled, enabled);
    UI::ChangeWidget(`id(`add_button), `Enabled, enabled);
    UI::ChangeWidget(`id(`edit_button), `Enabled, enabled);
    UI::ChangeWidget(`id(`delete_button), `Enabled, enabled);
    UI::ChangeWidget(`id(`switch_button), `Enabled, enabled);


    any ret = nil;
    while (true)
    {
	ret = UI::UserInput ();
	if (ret == `delete_button)
	{
        selected = UI::QueryWidget(`id(`profiles), `CurrentItem);
        if (selected == active)
			// Popup text (user wants to delete active profile):
            UI::MessagePopup(_("You cannot delete the active profile."));
        else
        {
			// Popup text (confirmation)
            if (UI::YesNoPopup(sformat(_("Do you really want to delete profile %1?"), selected)))
            {
                if (!ProfileManager::DeleteProfile(selected))
					// Error popup text
                    UI::ErrorPopup(_("Deleting profile was not succesfull."));
                break;
            }
        }
		continue;
	}
    else if (ret == `add_button)
	{
		if (AddProfilePopup())
			return `edit_button;
		else continue;
	}
    else if (ret == `edit_button)
	{
        ProfileManager::selected_profile = UI::QueryWidget(`id(`profiles), `CurrentItem);
        ProfileManager::profile_action = "edit";
        break;
	}
    else if (ret == `switch_button)
    {
        selected = UI::QueryWidget(`id(`profiles), `CurrentItem);
        if (selected == active) {
			// Popup text:
            UI::MessagePopup(_("It does not make a sense to switch to the active profile."));
            continue;
        }
        else {
            ProfileManager::selected_profile = selected;

            if (!ProfileManager::PrepareSwitch())
            {
                // Error popup text
                UI::ErrorPopup(_("Switching to another profile is not possible."));
                continue;

            }

            block func = ``{};
/*            if (!ProfileManager::PrepareSwitch())
            {
                // Error popup text
                UI::ErrorPopup(_("Switching to another profile is not possible."));
                continue;

            }
            };*/
            ProgressPopup( func );
            break;
        }
    }
    else if (ret == `next || ret ==`back || ret == `options_button)
	    break;

    };

    return ret;
}


/**
 */
global define any OptionsDialog () ``{

    string separator = "-----";
    string selected = "";

    ProfileManager::ReadResourceSets();

    list resource_sets = union( union (ProfileManager::resource_sets_predefined, [ separator ]), ProfileManager::resource_sets_individual);
    boolean close_popups = ProfileManager::close_popups;

	// Dialog caption label:
    string caption = _("SCPM Options");
    term contents = `HBox(`HSpacing(1.5),
        `VBox(
        `VSpacing(1),
		// frame label:
        `Frame(_("Enable SCPM"), `VBox(
            `VSpacing(0.5),
                `RadioButtonGroup(`id(`rb),
		            `HBox(
				    `HCenter(`RadioButton(`id(`ena), _("&Enabled") )),
                    `HCenter(`RadioButton(`id(`dis), _("&Disabled") ))
                    )
				 ),
		    `VSpacing(0.5)
            )),
        `VSpacing(1),
		// frame label
		`Frame(_("Resource Sets"), `VBox(
            `VSpacing(0.2),
            `HBox(
                `HSpacing(1),
                `SelectionBox(`id(`resources),
				    // selection box label:
                    _("Choose a &resource set:"), resource_sets),
/*                `HSpacing(1),
                `VBox(
                `PushButton(`id(`cp_button), _("Co&py")),
                `PushButton(`id(`ed_button), _("Ed&it")),
                `PushButton(`id(`del_button), _("Dele&te"))
                ),*/
                `HSpacing(1)
                ),
            `VSpacing(0.5)
            )),
        `VSpacing(1),
		// frame label:
		`Frame(_("Other settings"), `VBox(
            `VSpacing(0.5),
            `HBox(
                `HSpacing(1),
		        `Left(`CheckBox(`id(`close_popups_ch),
				    // checkbox label
                    _("Close progress popups &automaticaly"), close_popups))
                ),
            `VSpacing(0.5)
            )),
		`VSpacing(1)),
        `HSpacing(1.5));

    Wizard::RestoreBackButton ();

    Wizard::SetContentsButtons ( caption,
				contents,
	            HELPS["options"]:"",
				CancelButtonLabel (),
				OKButtonLabel () );

    if (ProfileManager::enabled)
    {
        UI::ChangeWidget(`id(`rb), `CurrentButton, `ena);
    }
    else
        UI::ChangeWidget(`id(`rb), `CurrentButton, `dis);

    if (size(ProfileManager::current_resources)>0)
        UI::ChangeWidget(`id(`resources), `CurrentItem,
            ProfileManager::current_resources);

    any ret = nil;
    while (true)
    {
	ret = UI::UserInput ();
    if (ret == `rb)
    {
        continue;
    }
    else if (ret == `cp_button)
    {
/*        // check same names!!! -> two lists!
        selected = UI::QueryWidget(`id(`resources), `CurrentItem);
        if (selected == separator)
        {
            // Popup label:
            UI::MessagePopup(_("You have to choose valid resource set."));
            continue;
        }
        string newset = CopyResourcePopup();
        if (newset != "")
            ProfileManager::CopyResourceSet(selected, newset);
        break;*/
        continue;
    }
    else if (ret == `ed_button)
    {
        continue;
    }
    else if (ret == `del_button)
    {
/*        selected = UI::QueryWidget(`id(`resources), `CurrentItem);
        if (selected == separator ||
            contains(ProfileManager::resource_sets_predefined,selected))
        {
            // Popup label:
            UI::MessagePopup(_("You can delete only individual resource set."));
            continue;
        }

        if (UI::YesNoPopup(sformat(
            _("Do you really want to delete resource set %1?"), selected)))
        {
            ProfileManager::DeleteResourceSet(selected);
            break;
        }*/
        continue;
    }
    else if (ret == `next)
    {
        close_popups = UI::QueryWidget(`id(`close_popups_ch), `Value);
        boolean run_progress = false;

        if (UI::QueryWidget(`id(`rb), `CurrentButton) == `ena) {

            selected = UI::QueryWidget(`id(`resources), `CurrentItem);
            if (selected == separator || selected == nil)
            {
				// Popup label:
                UI::MessagePopup(_("You should choose a resource set first."));
                continue;
            }

            if (!ProfileManager::enabled)
            {
                ProfileManager::enabled = true;
                if (!ProfileManager::WriteSCPMStatus())
                {
                    // Error popup text
                    UI::ErrorPopup(_("Enabling SCPM was not succesfull."));
                    ProfileManager::enabled = false;
                    break;
                }
                block func = ``{};
                ProgressPopup(func);

                ProfileManager::current_resources = selected;
                ProfileManager::WriteResources(selected);

				if (!ProfileManager::initialized)
                {
                    ProfileManager::initialized = true;
                    run_progress = true;
                }

				ProfileManager::ReadProfiles(); // on some other place!
				ProfileManager::ReadActiveProfile();
				ProfileManager::ReadProfilesDescriptions();
            }

			else if (ProfileManager::current_resources != selected)
            {
				// Popup label (confirmation)
				if (UI::YesNoPopup(_("Changing the Resource Set may drop some of your configuration settings. Are you sure you want to proceed?")))
				{
					ProfileManager::current_resources = selected;
					// maybe WriteResources should be run every time
					ProfileManager::WriteResources(selected);
					ProfileManager::RebuildDB();
					run_progress = true; // not necessary ?
                    block func = ``{};
                    ProgressPopup(func);
				}
				else continue;
            }
        }
        else
        {
            if (ProfileManager::enabled)
            {
                ProfileManager::enabled = false;
                ProfileManager::current_resources = "";
                if (!ProfileManager::WriteSCPMStatus())
                {
                    // Error popup text
                    UI::ErrorPopup(_("Disabling SCPM was not succesfull."));
                    ProfileManager::enabled = true;
                    break;
                }
				ProfileManager::profiles = $[];
         }
        }
		ProfileManager::close_popups = close_popups;

        y2debug("enabled=%1",ProfileManager::enabled);
        y2debug("close_popups=%1",ProfileManager::close_popups);
        y2debug("current_resources=%1",ProfileManager::current_resources);

	    break;
	}
    else if (ret == `back) break;

    else {
        y2error("Undefined return value");
        continue;
    }
    };

    return ret;
}


/* EOF */
}
